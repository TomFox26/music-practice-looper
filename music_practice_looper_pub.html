<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Practice Looper (Browser)</title>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7417905293760732"
     crossorigin="anonymous"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #202124;
      color: #e8eaed;
      margin: 0;
      padding: 24px;
    }
    .layout {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 16px;
    }
    .card {
      max-width: 520px;
      width: 100%;
      padding: 20px 24px;
      border-radius: 12px;
      background: #2d2f33;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }
    h1 {
      font-size: 20px;
      margin-top: 0;
      margin-bottom: 12px;
    }
    .row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    label {
      font-size: 14px;
    }
    button {
      padding: 6px 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      background: #4a90e2;
      color: white;
    }
    button.secondary {
      background: #5f6368;
    }
    button.danger {
      background: #d9534f;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    select, input[type="range"] {
      flex: 1;
      max-width: 160px;
    }
    #status {
      margin-top: 8px;
      font-size: 13px;
      color: #bdc1c6;
      min-height: 1.2em;
    }
    /* 広告枠（左右のみ） */
    .ad {
      width: 160px;
      min-height: 600px;
      background: #1a1b1f;
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #9aa0a6;
      font-size: 12px;
    }
    @media (max-width: 960px) {
      .layout {
        flex-direction: column;
        align-items: stretch;
      }
      .ad {
        width: 100%;
        min-height: 120px;
      }
    }

    /* 再生バーまわり */
    #seekRow span {
      font-size: 12px;
      color: #bdc1c6;
      min-width: 38px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- 左広告枠 -->
    <aside class="ad" id="ad-left">
      左側広告エリア
    </aside>

    <main class="card">
      <h1>Practice Looper (Browser)</h1>

      <div class="row">
        <button id="sourceBtn" class="secondary">音源選択</button>
        <button id="recordBtn">録音開始</button>
        <button id="playBtn" class="secondary" disabled>再生</button>
      </div>

      <div class="row">
        <label for="duration">録音長 (秒):</label>
        <!-- 上限を 120 秒に変更 -->
        <input type="number" id="duration" min="3" max="120" value="60" style="width:80px;">
        <!-- 最長録音時間の表示 -->
        <span id="maxDurationInfo" style="font-size:12px; color:#bdc1c6;"></span>
      </div>

      <div class="row">
        <label for="speedSelect">再生速度:</label>
        <select id="speedSelect">
          <option value="0.25">0.25x</option>
          <option value="0.5">0.5x</option>
          <option value="0.75">0.75x</option>
          <option value="1.0" selected>1.0x</option>
        </select>

        <label>
          <input type="checkbox" id="loopCheckbox" checked>
          ループ再生
        </label>
      </div>

      <div class="row">
        <label>
          <input type="checkbox" id="countCheckbox" checked>
          再生前にカウント
        </label>

        <label style="margin-left:auto;">カウント音量:</label>
        <input type="range" id="countVolume" min="0" max="100" value="60">
      </div>

      <!-- 再生バー（シークバー＋時間表示） -->
      <div class="row" id="seekRow">
        <span id="currentTime">0:00</span>
        <input
          type="range"
          id="seekBar"
          min="0"
          max="0"
          value="0"
          step="0.01"
          style="flex:1;"
          disabled
        >
        <span id="totalTime">0:00</span>
      </div>

      <!-- ユーザーにはコントロールを出さない -->
      <audio id="audioPlayer"></audio>

      <div id="status"></div>
    </main>

    <!-- 右広告枠 -->
    <aside class="ad" id="ad-right">
      右側広告エリア
    </aside>
  </div>

  <script>
    // 録音可能な最長秒数（ここを変えれば一括で反映）
    const MAX_DURATION = 120;

    const sourceBtn = document.getElementById("sourceBtn");
    const recordBtn = document.getElementById("recordBtn");
    const playBtn = document.getElementById("playBtn");
    const durationInput = document.getElementById("duration");
    const speedSelect = document.getElementById("speedSelect");
    const loopCheckbox = document.getElementById("loopCheckbox");
    const countCheckbox = document.getElementById("countCheckbox");
    const countVolumeSlider = document.getElementById("countVolume");
    const statusEl = document.getElementById("status");
    const audioEl = document.getElementById("audioPlayer");
    const maxDurationInfo = document.getElementById("maxDurationInfo");

    // 再生バー関連
    const seekBar = document.getElementById("seekBar");
    const currentTimeEl = document.getElementById("currentTime");
    const totalTimeEl = document.getElementById("totalTime");

    let captureStream = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    let audioURL = null;
    let isRecording = false;
    let audioCtx = null;

    // 「最長録音時間：XXX秒」を表示
    maxDurationInfo.textContent = `最長録音時間：${MAX_DURATION}秒`;

    function logStatus(text) {
      statusEl.textContent = text;
    }

    function setPreservePitch(el, v) {
      try { el.preservesPitch = v; } catch {}
      try { el.mozPreservesPitch = v; } catch {}
      try { el.webkitPreservesPitch = v; } catch {}
    }

    // mm:ss 形式に整形
    function formatTime(seconds) {
      if (!isFinite(seconds) || seconds < 0) seconds = 0;
      seconds = Math.floor(seconds);
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return `${m}:${s.toString().padStart(2, "0")}`;
    }

    // --- 音源ウィンドウ選択 ---
    async function chooseCaptureSource() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
        alert("getDisplayMedia がサポートされていません。Chrome / Edge の最新版でお試しください。");
        return;
      }
      try {
        if (captureStream) {
          captureStream.getTracks().forEach(t => t.stop());
          captureStream = null;
        }

        logStatus("キャプチャする画面/タブと音声を選択してください...");
        const stream = await navigator.mediaDevices.getDisplayMedia({
          video: true,
          audio: true
        });

        const audioTracks = stream.getAudioTracks();
        if (audioTracks.length === 0) {
          stream.getTracks().forEach(t => t.stop());
          logStatus("選択した画面/タブに音声トラックがありません。「音声を共有」にチェックを入れてください。");
          return;
        }

        captureStream = stream;
        logStatus("音源が選択されました。録音開始できます。");
      } catch (err) {
        console.error(err);
        logStatus("音源選択に失敗しました: " + err.message);
      }
    }

    sourceBtn.addEventListener("click", () => {
      chooseCaptureSource();
    });

    // --- 録音 ---
    async function startRecording() {
      const userVal = Number(durationInput.value) || 60;
      const maxSec = Math.max(3, Math.min(MAX_DURATION, userVal));
      durationInput.value = maxSec;  // 入力値を補正
      // ここで MAX_DURATION を使っているので 120 秒が上限になる

      if (!captureStream) {
        logStatus("先に「音源選択」ボタンで画面/タブ＋音声を選択してください。");
        return;
      }

      try {
        const audioTracks = captureStream.getAudioTracks();
        if (audioTracks.length === 0) {
          logStatus("選択したストリームに音声トラックがありません。もう一度音源選択してください。");
          return;
        }
        const audioStream = new MediaStream(audioTracks);

        let options = {};
        if (MediaRecorder.isTypeSupported("audio/webm;codecs=opus")) {
          options.mimeType = "audio/webm;codecs=opus";
        } else if (MediaRecorder.isTypeSupported("audio/webm")) {
          options.mimeType = "audio/webm";
        } else if (MediaRecorder.isTypeSupported("video/webm;codecs=vp9,opus")) {
          options.mimeType = "video/webm;codecs=vp9,opus";
        }

        recordedChunks = [];
        mediaRecorder = new MediaRecorder(audioStream, options);

        mediaRecorder.ondataavailable = (e) => {
          if (e.data && e.data.size > 0) {
            recordedChunks.push(e.data);
          }
        };

        mediaRecorder.onstop = async () => {
          if (!recordedChunks.length) {
            logStatus("録音データがありません。");
            return;
          }
          const blob = new Blob(recordedChunks, { type: mediaRecorder.mimeType || "audio/webm" });
          if (audioURL) {
            URL.revokeObjectURL(audioURL);
          }
          audioURL = URL.createObjectURL(blob);
          audioEl.src = audioURL;
          audioEl.load();
          playBtn.disabled = false;
          logStatus("録音完了。再生ボタンで確認できます。");
        };

        mediaRecorder.start();
        isRecording = true;
        recordBtn.textContent = "録音停止";
        recordBtn.classList.add("danger");
        playBtn.disabled = true;
        logStatus("録音中...");

        setTimeout(() => {
          if (isRecording) {
            stopRecording();
          }
        }, maxSec * 1000);

      } catch (err) {
        console.error(err);
        logStatus("録音開始に失敗しました: " + err.message);
      }
    }

    function stopRecording() {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
      }
      isRecording = false;
      recordBtn.textContent = "録音開始";
      recordBtn.classList.remove("danger");
      logStatus("録音停止。処理中...");
    }

    recordBtn.addEventListener("click", () => {
      if (!isRecording) {
        startRecording();
      } else {
        stopRecording();
      }
    });

    // --- カウント音 ---
    function ensureAudioContext() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
    }

    function playBeep() {
      ensureAudioContext();
      const vol = Number(countVolumeSlider.value) / 100;
      if (vol <= 0) return;

      const ctx = audioCtx;
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();

      osc.type = "sine";
      osc.frequency.value = 1000;

      osc.connect(gain);
      gain.connect(ctx.destination);

      const now = ctx.currentTime;
      const duration = 0.08;

      gain.gain.setValueAtTime(0, now);
      gain.gain.linearRampToValueAtTime(vol, now + 0.01);
      gain.gain.linearRampToValueAtTime(0, now + duration);

      osc.start(now);
      osc.stop(now + duration);
    }

    function sleep(ms) {
      return new Promise((resolve) => setTimeout(resolve, ms));
    }

    // --- 再生＋カウントイン ---
    async function playWithCountIn() {
      if (!audioEl.src) {
        alert("まだ録音されていません。");
        return;
      }

      const speed = parseFloat(speedSelect.value);
      audioEl.playbackRate = speed;
      setPreservePitch(audioEl, true);

      if (countCheckbox.checked) {
        logStatus("カウント中...");
        for (let i = 0; i < 4; i++) {
          playBeep();
          await sleep(500);
        }
      }

      logStatus("再生中...");
      audioEl.currentTime = 0;
      seekBar.value = 0;
      currentTimeEl.textContent = "0:00";

      try {
        await audioEl.play();
      } catch (err) {
        console.error(err);
        logStatus("再生に失敗しました: " + err.message);
      }
    }

    speedSelect.addEventListener("change", () => {
      const speed = parseFloat(speedSelect.value);
      audioEl.playbackRate = speed;
      setPreservePitch(audioEl, true);
    });

    playBtn.addEventListener("click", () => {
      if (audioEl.paused) {
        playWithCountIn();
        playBtn.textContent = "停止";
        playBtn.classList.remove("secondary");
      } else {
        audioEl.pause();
        audioEl.currentTime = 0;
        seekBar.value = 0;
        currentTimeEl.textContent = "0:00";
        playBtn.textContent = "再生";
        playBtn.classList.add("secondary");
        logStatus("停止中");
      }
    });

    // --- 再生バーの更新・シーク ---
    audioEl.addEventListener("loadedmetadata", () => {
      if (isFinite(audioEl.duration)) {
        seekBar.max = audioEl.duration;
        seekBar.value = 0;
        seekBar.disabled = false;
        totalTimeEl.textContent = formatTime(audioEl.duration);
        currentTimeEl.textContent = "0:00";
      }
    });

    audioEl.addEventListener("timeupdate", () => {
      if (!isNaN(audioEl.currentTime)) {
        seekBar.value = audioEl.currentTime;
        currentTimeEl.textContent = formatTime(audioEl.currentTime);
      }
    });

    // ユーザーがバーをドラッグしたときにシーク
    seekBar.addEventListener("input", () => {
      if (seekBar.disabled) return;
      const t = Number(seekBar.value) || 0;
      audioEl.currentTime = t;
      currentTimeEl.textContent = formatTime(t);
    });

    audioEl.addEventListener("ended", () => {
      if (loopCheckbox.checked) {
        playWithCountIn();  // ループ時も毎回カウントから
      } else {
        playBtn.textContent = "再生";
        playBtn.classList.add("secondary");
        seekBar.value = 0;
        currentTimeEl.textContent = "0:00";
        logStatus("停止中");
      }
    });

    logStatus("まず「音源選択」ボタンで音を取るウィンドウ/タブを選んでください。");
  </script>
</body>
</html>


